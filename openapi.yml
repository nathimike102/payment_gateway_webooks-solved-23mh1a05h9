openapi: 3.0.0
info:
  title: Payment Gateway API
  description: Production-ready payment gateway with async processing and webhooks
  version: 1.0.0
  contact:
    name: Payment Gateway Team
  license:
    name: MIT

servers:
  - url: http://localhost:8000
    description: Local development server
  - url: https://api.paymentgateway.com
    description: Production server

tags:
  - name: Health
    description: System health checks
  - name: Orders
    description: Order management endpoints
  - name: Payments
    description: Payment processing endpoints
  - name: Refunds
    description: Refund management endpoints
  - name: Queue
    description: Job queue monitoring endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Check if the API is running and database is connected
      responses:
        "200":
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "healthy"
                  database:
                    type: string
                    example: "connected"
                  timestamp:
                    type: string
                    format: date-time

  /api/v1/orders:
    post:
      tags:
        - Orders
      summary: Create a new order
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                amount:
                  type: integer
                  minimum: 100
                  example: 50000
                  description: Amount in paise (1 INR = 100 paise)
                currency:
                  type: string
                  default: "INR"
                  example: "INR"
                receipt:
                  type: string
                  example: "receipt_123"
                notes:
                  type: object
                  description: Additional metadata
              required:
                - amount
      responses:
        "201":
          description: Order created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "400":
          description: Invalid request
        "401":
          description: Unauthorized

    get:
      tags:
        - Orders
      summary: Get all orders for merchant
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of orders
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  total:
                    type: integer
                  orders:
                    type: array
                    items:
                      $ref: "#/components/schemas/Order"

  /api/v1/orders/{order_id}:
    get:
      tags:
        - Orders
      summary: Get order by ID
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: order_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Order details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "404":
          description: Order not found

  /api/v1/payments:
    post:
      tags:
        - Payments
      summary: Create a payment
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/UPIPayment"
                - $ref: "#/components/schemas/CardPayment"
      responses:
        "201":
          description: Payment created and enqueued for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Payment"
        "400":
          description: Invalid payment details
        "401":
          description: Unauthorized
        "404":
          description: Order not found

    get:
      tags:
        - Payments
      summary: Get all payments for merchant
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
      responses:
        "200":
          description: List of payments
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  total:
                    type: integer
                  payments:
                    type: array
                    items:
                      $ref: "#/components/schemas/Payment"

  /api/v1/payments/{payment_id}:
    get:
      tags:
        - Payments
      summary: Get payment by ID
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: payment_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Payment details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Payment"
        "404":
          description: Payment not found

  /api/v1/refunds:
    post:
      tags:
        - Refunds
      summary: Create a refund (async)
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: Idempotency-Key
          in: header
          schema:
            type: string
          description: Unique key for idempotent requests
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                payment_id:
                  type: string
                  example: "pay_abc123xyz"
                amount:
                  type: integer
                  description: Amount in paise (optional, defaults to full payment amount)
                reason:
                  type: string
                  example: "Customer request"
                idempotency_key:
                  type: string
                  description: Unique key for idempotent requests
              required:
                - payment_id
      responses:
        "201":
          description: Refund created and enqueued for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Refund"
        "400":
          description: Invalid refund request
        "401":
          description: Unauthorized
        "404":
          description: Payment not found

    get:
      tags:
        - Refunds
      summary: Get all refunds for merchant
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: limit
          in: query
          schema:
            type: integer
            default: 50
        - name: skip
          in: query
          schema:
            type: integer
            default: 0
        - name: payment_id
          in: query
          schema:
            type: string
          description: Filter by payment ID
      responses:
        "200":
          description: List of refunds
          content:
            application/json:
              schema:
                type: object
                properties:
                  count:
                    type: integer
                  total:
                    type: integer
                  refunds:
                    type: array
                    items:
                      $ref: "#/components/schemas/Refund"

  /api/v1/refunds/{refund_id}:
    get:
      tags:
        - Refunds
      summary: Get refund by ID
      security:
        - ApiKeyAuth: []
        - ApiSecretAuth: []
      parameters:
        - name: refund_id
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Refund details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Refund"
        "404":
          description: Refund not found

  /api/v1/queue/status:
    get:
      tags:
        - Queue
      summary: Get job queue status
      responses:
        "200":
          description: Queue statistics
          content:
            application/json:
              schema:
                type: object
                properties:
                  webhooks:
                    $ref: "#/components/schemas/QueueStats"
                  payments:
                    $ref: "#/components/schemas/QueueStats"
                  refunds:
                    $ref: "#/components/schemas/QueueStats"

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-Api-Key
    ApiSecretAuth:
      type: apiKey
      in: header
      name: X-Api-Secret

  schemas:
    Order:
      type: object
      properties:
        id:
          type: string
          example: "order_abc123xyz"
        merchant_id:
          type: string
          format: uuid
        amount:
          type: integer
          example: 50000
        currency:
          type: string
          example: "INR"
        receipt:
          type: string
        notes:
          type: object
        status:
          type: string
          enum: [created, processed, completed, failed]
          example: "created"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Payment:
      type: object
      properties:
        id:
          type: string
          example: "pay_xyz123abc"
        order_id:
          type: string
          example: "order_abc123xyz"
        merchant_id:
          type: string
          format: uuid
        amount:
          type: integer
          example: 50000
        currency:
          type: string
          example: "INR"
        method:
          type: string
          enum: [upi, card]
          example: "upi"
        status:
          type: string
          enum: [created, processing, success, failed]
          example: "created"
        vpa:
          type: string
          example: "user@paytm"
        card_network:
          type: string
          example: "VISA"
        card_last4:
          type: string
          example: "1111"
        error_code:
          type: string
        error_description:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    Refund:
      type: object
      properties:
        id:
          type: string
          example: "refund_abc123xyz"
        payment_id:
          type: string
          example: "pay_xyz123abc"
        order_id:
          type: string
          example: "order_abc123xyz"
        merchant_id:
          type: string
          format: uuid
        amount:
          type: integer
          example: 50000
        currency:
          type: string
          example: "INR"
        reason:
          type: string
          example: "Customer request"
        status:
          type: string
          enum: [created, processing, processed, failed]
          example: "created"
        error_code:
          type: string
        error_description:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UPIPayment:
      type: object
      properties:
        order_id:
          type: string
          example: "order_abc123xyz"
        method:
          type: string
          const: "upi"
        vpa:
          type: string
          example: "user@paytm"
      required:
        - order_id
        - method
        - vpa

    CardPayment:
      type: object
      properties:
        order_id:
          type: string
          example: "order_abc123xyz"
        method:
          type: string
          const: "card"
        card:
          type: object
          properties:
            number:
              type: string
              example: "4111111111111111"
            expiry_month:
              type: string
              example: "12"
            expiry_year:
              type: string
              example: "2025"
            cvv:
              type: string
              example: "123"
            holder_name:
              type: string
              example: "John Doe"
          required:
            - number
            - expiry_month
            - expiry_year
            - cvv
            - holder_name
      required:
        - order_id
        - method
        - card

    QueueStats:
      type: object
      properties:
        waiting:
          type: integer
          example: 5
        active:
          type: integer
          example: 2
        completed:
          type: integer
          example: 150
        failed:
          type: integer
          example: 1

    WebhookPayload:
      type: object
      properties:
        id:
          type: string
          example: "pay_xyz123abc"
        event:
          type: string
          enum: [payment.created, refund.created]
          example: "payment.created"
        timestamp:
          type: string
          format: date-time
        order_id:
          type: string
        merchant_id:
          type: string
          format: uuid
        amount:
          type: integer
        currency:
          type: string
        method:
          type: string
        status:
          type: string
      description: Webhook payload signed with HMAC-SHA256. Verify using header X-Webhook-Signature
